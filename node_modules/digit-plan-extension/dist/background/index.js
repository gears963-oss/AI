chrome.runtime.onInstalled.addListener(()=>{});async function f(e,i={},n=12e3){const t=new AbortController,o=setTimeout(()=>t.abort(),n);try{return await fetch(e,{...i,signal:t.signal})}finally{clearTimeout(o)}}chrome.runtime.onMessage.addListener((e,i,n)=>{if(e?.type==="PIQ_SCORE_AI")return(async()=>{try{const o=(await chrome.storage.sync.get("PIQ_BACKEND_URL"))?.PIQ_BACKEND_URL;if(!o)throw new Error("BACKEND_URL manquant");console.log("[PIQ/bg] url=",o);const c=`${o.replace(/\/+$/,"")}/api/score`,p={icp:e.icp??{},features:e.features??{},pageText:typeof e.pageText=="string"?e.pageText.slice(0,3e4):""},l=1;let u=null;for(let a=0;a<=l;a++)try{const r=await f(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)},12e3);if(!r.ok)throw new Error(`HTTP ${r.status}`);const s=await r.json();n({ok:!0,data:s});return}catch(r){if(console.error(`[PIQ/bg] fetch attempt ${a+1} failed`,r),u=r,a===l)break;await new Promise(s=>setTimeout(s,800*Math.pow(2,a)))}throw new Error(u?.message||"Network error")}catch(t){console.error("[PIQ/bg] error",t),n({ok:!1,error:t?.message||String(t)})}})(),!0});
