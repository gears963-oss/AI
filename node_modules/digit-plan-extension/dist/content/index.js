(()=>{const p="prospectiq-badge",h="prospectiq-card",x="ICP_ACTIVE";if(document.getElementById(p))return;function b(){const e=document.createElement("button");e.id=p,e.textContent="Score ICP",e.style.position="fixed",e.style.bottom="16px",e.style.right="16px",e.style.zIndex="2147483647",e.style.background="#22c55e",e.style.color="#0f172a",e.style.fontWeight="700",e.style.border="0",e.style.borderRadius="10px",e.style.padding="10px 12px",e.style.boxShadow="0 6px 20px rgba(2,6,23,0.35)",e.style.cursor="pointer",e.addEventListener("click",I),document.body.appendChild(e)}async function _(){try{return(await chrome.storage.sync.get(x))?.[x]||{}}catch{return{}}}function C(){const e=location.hostname.toLowerCase(),o=document.documentElement.outerHTML||"",n=document.body?.innerText||"",t={pays:void 0,secteur_text:void 0,taille_estimee:void 0,role_text:void 0,note_google:void 0,techno_detectees:[],texte:n.slice(0,2e3)},s=e.match(/\.([a-z]{2})(?:$|:|\/)/),r={fr:"FR",de:"DE",es:"ES",it:"IT",nl:"NL",be:"BE",ch:"CH",uk:"UK"};if(s&&(t.pays=r[s[1]]||s[1].toUpperCase()),/(^|\.)(google\.)[^/]+\/maps/.test(location.href)||/maps\.google\./.test(e)){let c;const u=document.querySelector('[aria-label*="Étoiles"], [aria-label*="stars"], [aria-label*="rating"]');if(u){const d=(u.getAttribute("aria-label")||"").match(/(\d+[.,]\d+)/);d&&(c=Number(d[1].replace(",",".")))}if(c==null){const d=o.match(/(\d+,[0-9])\s*★/);d&&(c=Number(d[1].replace(",",".")))}return t.note_google=c,t}if(e.includes("linkedin.com")){const c=document.querySelector("h1")?.textContent||""||document.querySelector("h2")?.textContent||"";t.role_text=c.trim()||void 0;const u=document.querySelector(".inline-show-more-text");if(u&&(t.secteur_text=u.textContent?.trim()),!t.secteur_text){const m=document.querySelector('meta[name="industry"], meta[property="og:description"]');m&&(t.secteur_text=m.getAttribute("content")||void 0)}const d=(n.match(/(\d[\d\s]*)(?:\+)?\s*employ[eé]s?/i)||[])[0]||"",g=d.match(/(\d+)\s*[-–]\s*(\d+)/);if(g){const m=Number(g[1]),E=Number(g[2]);t.taille_estimee=Math.round((m+E)/2)}else{const m=d.match(/(\d+)\s*\+\s*employ/i);m&&(t.taille_estimee=Number(m[1]))}return t}try{(window.Shopify||/shopify/i.test(o)||Array.from(document.scripts).some(c=>/shopify/i.test(c.src)))&&t.techno_detectees.push("Shopify")}catch{}(/woocommerce/i.test(o)||Array.from(document.scripts).some(c=>/woocommerce/i.test(c.src)))&&t.techno_detectees.push("WooCommerce");const a=document.querySelector('meta[name="description"]')?.getAttribute("content")||"";return t.secteur_text=a||document.title||void 0,t}function f(e,o){if(!e)return!1;const n=e.toLowerCase();return o.some(t=>n.includes(String(t).toLowerCase()))}function S(e,o){let n=0;const t=[],s=e.secteurs||[],r=e.roles||[],l=e.techno_inclues||[],i=e.exclusions_mots||[];if(e.pays&&o.pays&&String(e.pays).toUpperCase()===String(o.pays).toUpperCase()&&(n+=25,t.push("Pays/TLD correspondant (+25)")),s.length&&(f(o.secteur_text,s)||f(o.texte,s))&&(n+=20,t.push("Secteur correspondant (+20)")),(e.taille_min!=null||e.taille_max!=null)&&o.taille_estimee!=null){const a=e.taille_min!=null?Number(e.taille_min):-1/0,c=e.taille_max!=null?Number(e.taille_max):1/0;o.taille_estimee>=a&&o.taille_estimee<=c&&(n+=15,t.push("Taille dans la plage (+15)"))}return r.length&&f(o.role_text,r)&&(n+=15,t.push("Rôle ciblé présent (+15)")),(o.techno_detectees||[]).length&&l.length&&o.techno_detectees.filter(c=>l.map(u=>String(u).toLowerCase()).includes(String(c).toLowerCase())).length&&(n+=10,t.push("Technologie demandée détectée (+10)")),e.note_google_max!=null&&o.note_google!=null&&Number(o.note_google)<=Number(e.note_google_max)&&(n+=10,t.push("Note Google sous le seuil (+10)")),i.length&&f(o.texte,i)&&(n-=20,t.push("Mot-clé d’exclusion détecté (-20)")),n=Math.max(0,Math.min(100,n)),{score:n,reasons:t}}function y(e){let o=document.getElementById(h);o||(o=document.createElement("div"),o.id=h,o.style.position="fixed",o.style.bottom="64px",o.style.right="16px",o.style.zIndex="2147483647",o.style.background="#0f172a",o.style.color="#fff",o.style.padding="12px 14px",o.style.borderRadius="10px",o.style.boxShadow="0 6px 24px rgba(2,6,23,0.4)",o.style.width="320px",document.body.appendChild(o)),o.replaceChildren();const n=document.createElement("div");n.style.fontWeight="700",n.style.marginBottom="6px",n.textContent=`Score: ${Number(e.score)}/100`,o.appendChild(n);const t=document.createElement("ul");t.style.margin="0",t.style.padding="0",t.style.listStyle="none",t.style.fontSize="12px",t.style.color="#cbd5e1";for(const r of(e.reasons||[]).slice(0,3)){const l=document.createElement("li");l.textContent=`• ${r}`,t.appendChild(l)}o.appendChild(t);const s=document.getElementById(p);if(s){const r=Number(e.score)||0;r>=75?(s.style.background="#22c55e",s.style.color="#0f172a"):r>=50?(s.style.background="#f59e0b",s.style.color="#0f172a"):(s.style.background="#64748b",s.style.color="#ffffff")}}async function I(){console.log("[PIQ/content] scoring click",location.href);const e=await _(),o=C(),n=(o.texte||document.body?.innerText||"").slice(0,3e4),t=S(e,o);y({score:t.score,reasons:[...(t.reasons||[]).slice(0,2),"IA: pending…"]});try{const s=await new Promise(i=>{chrome.runtime.sendMessage({type:"PIQ_SCORE_AI",icp:e,features:o,pageText:n},a=>i(a))});let r=t.score,l=[...t.reasons||[]];if(s&&s.ok&&s.data){const i=s.data,a=Number(i.score_ai)||0;r=Math.round(.6*t.score+.4*a);const c=Array.isArray(i.reasons_ai)&&i.reasons_ai[0]?i.reasons_ai[0]:void 0;l=[...(t.reasons||[]).slice(0,2)],c&&l.push(c)}else l=[...(t.reasons||[]).slice(0,2),"IA offline — score règles affiché"];y({score:r,reasons:l})}catch{const s=[...(t.reasons||[]).slice(0,2),"IA offline — score règles affiché"];y({score:t.score,reasons:s})}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",b,{once:!0}):b()})();console.debug("[ProspectIQ] content script loaded");
